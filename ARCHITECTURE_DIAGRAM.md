# ATP 互動式圖表與自動分析 - 系統架構圖

## 系統架構總覽

```
┌─────────────────────────────────────────────────────────────────────┐
│                          使用者界面層                                │
│                        (User Interface)                              │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    Streamlit Web Application                  │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐             │  │
│  │  │  任務選擇   │  │  互動圖表   │  │  分析報告   │            │  │
│  │  │  面板       │  │  面板       │  │  面板       │            │  │
│  │  └────────────┘  └────────────┘  └────────────┘             │  │
│  │                                                               │  │
│  │  ┌──────────────────────────────────────────────────────┐   │  │
│  │  │            Interactive Chart Components              │   │  │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐            │   │  │
│  │  │  │ Plotly   │ │ Event    │ │ Data     │            │   │  │
│  │  │  │ Chart    │ │ Timeline │ │ Panel    │            │   │  │
│  │  │  └──────────┘ └──────────┘ └──────────┘            │   │  │
│  │  │  ┌──────────┐ ┌──────────┐                         │   │  │
│  │  │  │ Layer    │ │ Toolbar  │                         │   │  │
│  │  │  │ Control  │ │          │                         │   │  │
│  │  │  └──────────┘ └──────────┘                         │   │  │
│  │  └──────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                 ↕ HTTP/REST
┌─────────────────────────────────────────────────────────────────────┐
│                          API 服務層                                  │
│                        (API Services)                                │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                       FastAPI Application                     │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │              API Routers (路由)                        │  │  │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐             │  │  │
│  │  │  │ Analysis │ │ Reports  │ │ Charts   │             │  │  │
│  │  │  │ Router   │ │ Router   │ │ Router   │             │  │  │
│  │  │  └──────────┘ └──────────┘ └──────────┘             │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  │  ┌────────────────────────────────────────────────────────┐  │  │
│  │  │              Business Logic (業務邏輯)                │  │  │
│  │  │  ┌──────────────┐ ┌──────────────┐                  │  │  │
│  │  │  │  Anomaly     │ │  Trend       │                  │  │  │
│  │  │  │  Detector    │ │  Analyzer    │                  │  │  │
│  │  │  └──────────────┘ └──────────────┘                  │  │  │
│  │  │  ┌──────────────┐ ┌──────────────┐                  │  │  │
│  │  │  │  Report      │ │  Recommend   │                  │  │  │
│  │  │  │  Generator   │ │  Engine      │                  │  │  │
│  │  │  └──────────────┘ └──────────────┘                  │  │  │
│  │  └────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                    ↕                              ↕
        ┌───────────────────────┐   ┌───────────────────────┐
        │    Redis Cache        │   │   PostgreSQL DB       │
        │  ┌─────────────────┐  │   │  ┌─────────────────┐  │
        │  │ Analysis Results│  │   │  │ atp_missions    │  │
        │  │ Report Cache    │  │   │  │ records         │  │
        │  │ Session Data    │  │   │  │ events          │  │
        │  └─────────────────┘  │   │  │ stations        │  │
        └───────────────────────┘   │  │ balises         │  │
                                     │  └─────────────────┘  │
                                     └───────────────────────┘
```

## 數據流程圖

### 1. 互動式圖表載入流程

```
使用者 → 選擇任務
         ↓
    前端發送請求
    GET /api/v1/chart/data/{mission_id}
         ↓
    ┌────────────────┐
    │ FastAPI Router │
    └────────────────┘
         ↓
    檢查 Redis 快取
         ↓
    ┌─────────┴─────────┐
    │ 快取命中?         │
    └─────────┬─────────┘
         Yes │ │ No
             │ └──→ 查詢 PostgreSQL
             │           ↓
             │      處理與轉換數據
             │           ↓
             │      寫入 Redis 快取
             │           ↓
             └───────────┤
                         ↓
                   返回 JSON 數據
                         ↓
                   前端 Plotly 渲染
                         ↓
                   顯示互動式圖表
```

### 2. 異常偵測流程

```
使用者 → 請求異常偵測
         ↓
    GET /api/v1/analysis/anomalies/{mission_id}
         ↓
    ┌────────────────────┐
    │ Anomaly Detector   │
    │  Service           │
    └────────────────────┘
         ↓
    載入任務數據
         ↓
    ┌──────────────┬──────────────┬──────────────┐
    │ Overspeed    │ Harsh Brake  │ Speed Fluct  │
    │ Detection    │ Detection    │ Detection    │
    └──────┬───────┴──────┬───────┴──────┬───────┘
           │              │               │
           └──────────────┼───────────────┘
                          ↓
                     合併異常事件
                          ↓
                     嚴重度評級
                          ↓
                     生成建議
                          ↓
                     快取結果
                          ↓
                     返回 JSON
                          ↓
                     前端展示
```

### 3. 報告生成流程

```
使用者 → 請求生成報告
         ↓
    POST /api/v1/reports/generate
    { mission_id, format: "pdf" }
         ↓
    創建異步任務
         ↓
    返回 task_id
         ↓
    ┌────────────────────┐
    │ Background Worker  │
    │  (Async Task)      │
    └────────────────────┘
         ↓
    執行所有分析
    ┌────┴────┐
    │ Speed   │ → 速度分析結果
    │ Anomaly │ → 異常偵測結果
    │ Trend   │ → 趨勢分析結果
    │ Parking │ → 停車分析結果
    └────┬────┘
         ↓
    生成建議
         ↓
    填充報告模板
         ↓
    渲染 PDF/HTML
         ↓
    儲存報告檔案
         ↓
    更新任務狀態
         ↓
使用者輪詢狀態
    GET /api/v1/reports/status/{task_id}
         ↓
    狀態: completed
         ↓
使用者下載
    GET /api/v1/reports/download/{task_id}
```

## 組件互動圖

### 互動式圖表組件

```
┌───────────────────────────────────────────────────────────┐
│                  InteractiveChartPanel                    │
├───────────────────────────────────────────────────────────┤
│                                                           │
│  ┌─────────────────────────────────────────────────┐    │
│  │             Plotly Chart Canvas                 │    │
│  │  ┌──────────────────────────────────────────┐  │    │
│  │  │         Speed Curve (實際速度)           │  │    │
│  │  │         Target Speed (目標速度)          │  │    │
│  │  │         Event Markers (事件標記)         │  │    │
│  │  │         Annotation Zones (標註區域)      │  │    │
│  │  └──────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────┘    │
│                                                           │
│  ┌─────────────────────────────────────────────────┐    │
│  │               Toolbar (工具欄)                  │    │
│  │  [+] [-] [⟲] [✋] [✂] [📍] [💾] [⚙]          │    │
│  └─────────────────────────────────────────────────┘    │
│                                                           │
│  ┌──────────────┐  ┌──────────────┐                    │
│  │   Legend     │  │   Tooltip    │                    │
│  │   (圖例)     │  │   (提示)     │                    │
│  └──────────────┘  └──────────────┘                    │
│                                                           │
│  ┌─────────────────────────────────────────────────┐    │
│  │          Event Timeline (事件時間軸)            │    │
│  │  🚉      🚦      ⚠️       🚉       ⚠️        🚉  │    │
│  └─────────────────────────────────────────────────┘    │
│                                                           │
│  ┌─────────────────────────────────────────────────┐    │
│  │          Data Panel (數據面板)                  │    │
│  │  • 平均速度: 65 km/h                            │    │
│  │  • 最高速度: 90 km/h                            │    │
│  │  • 事件數量: 5                                  │    │
│  └─────────────────────────────────────────────────┘    │
│                                                           │
│  ┌─────────────────────────────────────────────────┐    │
│  │        Layer Control (圖層控制)                 │    │
│  │  ☑ 速度曲線                                     │    │
│  │  ☑ 目標速度                                     │    │
│  │  ☑ 事件標記                                     │    │
│  └─────────────────────────────────────────────────┘    │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

## 部署架構圖

### 容器化部署 (Docker)

```
┌────────────────────────────────────────────────────────────┐
│                    Docker Host Server                      │
│                                                            │
│  ┌──────────────────────────────────────────────────┐    │
│  │           Nginx Reverse Proxy                    │    │
│  │  Port 80/443                                     │    │
│  └────────────┬─────────────────────┬─────────────────    │
│               │                     │                     │
│  ┌────────────▼──────────┐  ┌──────▼──────────┐         │
│  │ Streamlit Container   │  │ FastAPI Container│         │
│  │ Port 8501             │  │ Port 8000        │         │
│  │ • streamlit_ui/       │  │ • api/           │         │
│  │ • components/         │  │ • services/      │         │
│  └───────────────────────┘  └──────────────────┘         │
│                                      │                    │
│  ┌──────────────────────┐   ┌───────▼──────────┐         │
│  │ Redis Container      │   │ PostgreSQL       │         │
│  │ Port 6379            │   │ Container        │         │
│  │ • Cache              │   │ Port 5432        │         │
│  │ • Session            │   │ • atp_missions   │         │
│  └──────────────────────┘   │ • records        │         │
│                              │ • events         │         │
│  ┌──────────────────────┐   └──────────────────┘         │
│  │ Prometheus/Grafana   │                               │
│  │ Port 9090/3000       │                               │
│  │ • Monitoring         │                               │
│  └──────────────────────┘                               │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

### 高可用性部署 (Production)

```
                    ┌──────────────┐
                    │ Load Balancer│
                    │  (Nginx)     │
                    └──────┬───────┘
                           │
        ┏━━━━━━━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━┓
        ↓                                     ↓
┌───────────────┐                    ┌───────────────┐
│  App Server 1 │                    │  App Server 2 │
│  ┌─────────┐  │                    │  ┌─────────┐  │
│  │Streamlit│  │                    │  │Streamlit│  │
│  └─────────┘  │                    │  └─────────┘  │
│  ┌─────────┐  │                    │  ┌─────────┐  │
│  │ FastAPI │  │                    │  │ FastAPI │  │
│  └─────────┘  │                    │  └─────────┘  │
└───────┬───────┘                    └───────┬───────┘
        │                                    │
        └────────────────┬───────────────────┘
                         ↓
                ┌────────────────┐
                │  Redis Cluster │
                │  (Primary+Replica)│
                └────────────────┘
                         ↓
                ┌────────────────┐
                │   PostgreSQL   │
                │   (Primary)    │
                └────────┬───────┘
                         │
                ┌────────▼───────┐
                │   PostgreSQL   │
                │   (Replica)    │
                └────────────────┘
```

## 技術堆疊圖

```
┌─────────────────────────────────────────────────────────┐
│                      Frontend Stack                     │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │ Streamlit  │  │  Plotly.js │  │   Pandas   │       │
│  │   1.28+    │  │   5.18+    │  │   2.1+     │       │
│  └────────────┘  └────────────┘  └────────────┘       │
└─────────────────────────────────────────────────────────┘
                         ↕
┌─────────────────────────────────────────────────────────┐
│                     Backend Stack                       │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │  FastAPI   │  │SQLAlchemy  │  │   Redis    │       │
│  │   0.104+   │  │   2.0+     │  │   7.0+     │       │
│  └────────────┘  └────────────┘  └────────────┘       │
└─────────────────────────────────────────────────────────┘
                         ↕
┌─────────────────────────────────────────────────────────┐
│                    Analysis Stack                       │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │   SciPy    │  │scikit-learn│  │statsmodels │       │
│  │   1.11+    │  │   1.3+     │  │   0.14+    │       │
│  └────────────┘  └────────────┘  └────────────┘       │
└─────────────────────────────────────────────────────────┘
                         ↕
┌─────────────────────────────────────────────────────────┐
│                     Database Layer                      │
│  ┌────────────────────────────────────────────┐        │
│  │            PostgreSQL 14+                  │        │
│  │  • atp_missions  • records  • events       │        │
│  └────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────┘
```

---

**架構設計原則**:
1. **分層架構**: 清晰的職責分離
2. **微服務思想**: 模組化、可擴展
3. **快取優先**: 減少資料庫壓力
4. **異步處理**: 提升響應速度
5. **容器化部署**: 易於擴展和維護

**文件版本**: 1.0  
**建立日期**: 2025-10-28
